# MoneyJars v2.0 系统架构设计文档

## 1. 项目概述

### 1.1 项目信息
- **项目名称**: MoneyJars v2.0
- **架构版本**: 2.0.0
- **更新日期**: 2025-01-20
- **架构模式**: Clean Architecture + Repository Pattern + Provider

### 1.2 核心功能
1. **拖拽式记账**: 创新的手势交互记账方式
2. **分类管理**: 支持多级分类和自定义类别
3. **数据可视化**: 饼图、趋势图等多维度数据展示
4. **数据持久化**: 本地存储和云同步支持
5. **主题系统**: 深色/浅色主题切换
6. **数据迁移**: 新旧架构数据无缝迁移

### 1.3 技术栈
```yaml
前端框架: Flutter 3.x
状态管理: Provider 6.x
依赖注入: get_it 7.x
本地存储: Hive 2.x
网络请求: Dio 5.x
图表库: fl_chart 0.x
动画框架: Flutter Animations
手势识别: GestureDetector
```

## 2. 架构设计原则

### 2.1 Clean Architecture 原则
- **独立性**: 业务逻辑独立于UI、数据库和外部框架
- **可测试性**: 业务规则可以在没有UI、数据库的情况下测试
- **UI独立性**: UI可以轻松更改，不影响系统其余部分
- **数据库独立性**: 可以轻松切换数据库实现

### 2.2 设计模式
- **Repository Pattern**: 数据访问抽象
- **Use Cases**: 业务逻辑封装
- **Dependency Injection**: 依赖注入实现解耦
- **Provider Pattern**: 状态管理
- **Factory Pattern**: 模型创建

## 3. 目录结构

### 3.1 完整目录树
```
lib/
├── main.dart                      # 旧版本入口（保留兼容）
├── main_new.dart                  # 新架构入口
├── app/                          # 应用配置层
│   └── app.dart                  # 应用主组件
├── core/                         # 核心业务逻辑
│   ├── domain/                   # 领域层
│   │   ├── entities/             # 业务实体
│   │   │   ├── category.dart
│   │   │   ├── subcategory.dart
│   │   │   └── transaction.dart
│   │   ├── repositories/         # 仓库接口
│   │   │   ├── category_repository.dart
│   │   │   └── transaction_repository.dart
│   │   └── usecases/            # 用例
│   │       ├── category/
│   │       │   ├── add_category.dart
│   │       │   ├── delete_category.dart
│   │       │   ├── get_categories.dart
│   │       │   └── update_category.dart
│   │       └── transaction/
│   │           ├── add_transaction.dart
│   │           ├── delete_transaction.dart
│   │           ├── get_transactions.dart
│   │           └── update_transaction.dart
│   ├── data/                    # 数据层
│   │   ├── datasources/         # 数据源
│   │   │   ├── local/
│   │   │   │   ├── hive_datasource.dart
│   │   │   │   └── default_categories.dart
│   │   │   └── remote/
│   │   │       └── api_datasource.dart
│   │   ├── models/              # 数据模型
│   │   │   ├── category_model.dart
│   │   │   ├── category_model.g.dart
│   │   │   ├── subcategory_model.dart
│   │   │   ├── subcategory_model.g.dart
│   │   │   ├── transaction_model.dart
│   │   │   └── transaction_model.g.dart
│   │   └── repositories/        # 仓库实现
│   │       ├── category_repository_impl.dart
│   │       └── transaction_repository_impl.dart
│   └── di/                      # 依赖注入
│       └── injection_container.dart
├── presentation/                # 表现层
│   ├── pages/                   # 页面
│   │   ├── home/
│   │   │   ├── home_page_new.dart
│   │   │   └── widgets/
│   │   │       ├── action_buttons.dart
│   │   │       ├── category_card.dart
│   │   │       └── transaction_list.dart
│   │   ├── settings/
│   │   │   ├── settings_page_new.dart
│   │   │   └── migration_page.dart
│   │   └── statistics/
│   │       └── statistics_page.dart
│   ├── providers/               # 状态管理
│   │   ├── category_provider.dart
│   │   ├── transaction_provider.dart
│   │   └── theme_provider.dart
│   └── widgets/                 # 共享组件
│       ├── common/
│       │   ├── loading_widget.dart
│       │   └── error_widget.dart
│       └── input/
│           ├── drag_input/
│           │   ├── drag_record_input_new.dart
│           │   ├── draggable_record_dot.dart
│           │   ├── category_pie_chart.dart
│           │   └── new_category_dialog.dart
│           └── quick_amount_input.dart
├── services/                    # 服务层
│   ├── storage_service.dart
│   ├── storage_service_web.dart
│   └── theme_service.dart
└── tools/                       # 工具
    └── migration/
        └── data_migration_tool.dart
```

## 4. 核心模块详解

### 4.1 领域层 (Domain Layer)

#### 4.1.1 实体定义
```dart
// category.dart
class Category {
  final String id;
  final String name;
  final String icon;
  final int color;
  final CategoryType type;
  final double currentAmount;
  final double targetAmount;
  final DateTime createdAt;
  final DateTime updatedAt;
  final List<SubCategory> subCategories;
}

// transaction.dart
class Transaction {
  final String id;
  final String categoryId;
  final String? subCategoryId;
  final double amount;
  final String? note;
  final DateTime date;
  final TransactionType type;
}
```

#### 4.1.2 用例实现
```dart
// add_transaction.dart
class AddTransaction {
  final TransactionRepository repository;
  
  AddTransaction(this.repository);
  
  Future<Either<Failure, Transaction>> call(TransactionParams params) async {
    return await repository.addTransaction(params.toEntity());
  }
}
```

### 4.2 数据层 (Data Layer)

#### 4.2.1 Hive数据源实现
```dart
class HiveDataSource implements LocalDataSource {
  static const String categoryBoxName = 'categories';
  static const String transactionBoxName = 'transactions';
  
  Future<void> init() async {
    Hive.registerAdapter(CategoryModelAdapter());
    Hive.registerAdapter(TransactionModelAdapter());
    await Hive.openBox<CategoryModel>(categoryBoxName);
    await Hive.openBox<TransactionModel>(transactionBoxName);
  }
  
  @override
  Future<List<CategoryModel>> getCategories() async {
    final box = Hive.box<CategoryModel>(categoryBoxName);
    return box.values.toList();
  }
}
```

#### 4.2.2 仓库实现
```dart
class CategoryRepositoryImpl implements CategoryRepository {
  final LocalDataSource localDataSource;
  final RemoteDataSource? remoteDataSource;
  
  @override
  Future<Either<Failure, List<Category>>> getCategories() async {
    try {
      final models = await localDataSource.getCategories();
      return Right(models.map((m) => m.toEntity()).toList());
    } catch (e) {
      return Left(CacheFailure());
    }
  }
}
```

### 4.3 表现层 (Presentation Layer)

#### 4.3.1 Provider状态管理
```dart
class CategoryProvider extends ChangeNotifier {
  final GetCategories getCategoriesUseCase;
  final AddCategory addCategoryUseCase;
  
  List<Category> _categories = [];
  bool _isLoading = false;
  
  List<Category> get categories => _categories;
  bool get isLoading => _isLoading;
  
  Future<void> loadCategories() async {
    _isLoading = true;
    notifyListeners();
    
    final result = await getCategoriesUseCase();
    result.fold(
      (failure) => _handleError(failure),
      (categories) {
        _categories = categories;
        _isLoading = false;
        notifyListeners();
      },
    );
  }
}
```

#### 4.3.2 拖拽输入组件实现
```dart
class DragRecordInputNew extends StatefulWidget {
  @override
  _DragRecordInputNewState createState() => _DragRecordInputNewState();
}

class _DragRecordInputNewState extends State<DragRecordInputNew> 
    with TickerProviderStateMixin {
  late AnimationController _scaleController;
  late AnimationController _fadeController;
  Offset _dragPosition = Offset.zero;
  Category? _selectedCategory;
  
  @override
  void initState() {
    super.initState();
    _scaleController = AnimationController(
      duration: Duration(milliseconds: 200),
      vsync: this,
    );
    _fadeController = AnimationController(
      duration: Duration(milliseconds: 300),
      vsync: this,
    );
  }
  
  void _handleDragUpdate(DragUpdateDetails details) {
    setState(() {
      _dragPosition = details.localPosition;
      _checkCategorySelection();
    });
  }
  
  void _checkCategorySelection() {
    // 计算当前拖拽位置对应的分类
    final angle = atan2(_dragPosition.dy - center.dy, 
                       _dragPosition.dx - center.dx);
    final categoryIndex = _calculateCategoryIndex(angle);
    _selectedCategory = categories[categoryIndex];
  }
}
```

## 5. 数据流架构

### 5.1 单向数据流
```
UI层 → Provider → Use Case → Repository → Data Source
     ←           ←          ←            ←
```

### 5.2 状态管理流程
1. UI触发事件（如添加交易）
2. Provider接收事件，调用对应Use Case
3. Use Case执行业务逻辑
4. Repository协调数据源
5. Data Source执行实际数据操作
6. 结果逐层返回，Provider更新状态
7. UI响应状态变化，更新界面

## 6. 关键技术实现

### 6.1 拖拽手势识别
```dart
class DragGestureRecognizer {
  static const double minDragDistance = 50.0;
  static const double categorySelectionRadius = 100.0;
  
  Category? detectCategory(Offset position, List<Category> categories) {
    final angle = atan2(position.dy, position.dx);
    final normalizedAngle = (angle + pi) / (2 * pi);
    final index = (normalizedAngle * categories.length).floor();
    return categories[index % categories.length];
  }
  
  bool isValidDrag(Offset start, Offset end) {
    final distance = (end - start).distance;
    return distance >= minDragDistance;
  }
}
```

### 6.2 动画系统
```dart
class AnimationManager {
  // 拖拽点动画
  Animation<double> createDragAnimation(AnimationController controller) {
    return Tween<double>(
      begin: 1.0,
      end: 1.2,
    ).animate(CurvedAnimation(
      parent: controller,
      curve: Curves.easeInOut,
    ));
  }
  
  // 分类选中动画
  Animation<double> createSelectionAnimation(AnimationController controller) {
    return Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: controller,
      curve: Curves.elasticOut,
    ));
  }
}
```

### 6.3 数据持久化
```dart
class PersistenceManager {
  static Future<void> saveTransaction(Transaction transaction) async {
    final box = Hive.box<TransactionModel>('transactions');
    await box.put(transaction.id, TransactionModel.fromEntity(transaction));
  }
  
  static Future<void> backupData() async {
    final categories = Hive.box<CategoryModel>('categories');
    final transactions = Hive.box<TransactionModel>('transactions');
    
    final backup = {
      'categories': categories.values.map((c) => c.toJson()).toList(),
      'transactions': transactions.values.map((t) => t.toJson()).toList(),
      'timestamp': DateTime.now().toIso8601String(),
    };
    
    // 保存到文件或云端
  }
}
```

### 6.4 依赖注入配置
```dart
final getIt = GetIt.instance;

Future<void> configureDependencies() async {
  // 数据源
  getIt.registerLazySingleton<LocalDataSource>(
    () => HiveDataSource(),
  );
  
  // 仓库
  getIt.registerLazySingleton<CategoryRepository>(
    () => CategoryRepositoryImpl(
      localDataSource: getIt(),
    ),
  );
  
  // 用例
  getIt.registerLazySingleton(() => GetCategories(getIt()));
  getIt.registerLazySingleton(() => AddCategory(getIt()));
  
  // Provider
  getIt.registerFactory(
    () => CategoryProvider(
      getCategoriesUseCase: getIt(),
      addCategoryUseCase: getIt(),
    ),
  );
}
```

## 7. API设计

### 7.1 内部API接口
```dart
// 分类管理
abstract class CategoryAPI {
  Future<List<Category>> getCategories();
  Future<Category> addCategory(Category category);
  Future<void> updateCategory(String id, Category category);
  Future<void> deleteCategory(String id);
}

// 交易管理
abstract class TransactionAPI {
  Future<List<Transaction>> getTransactions({
    DateTime? startDate,
    DateTime? endDate,
    String? categoryId,
  });
  Future<Transaction> addTransaction(Transaction transaction);
  Future<void> updateTransaction(String id, Transaction transaction);
  Future<void> deleteTransaction(String id);
  Future<TransactionStats> getStatistics(DateRange range);
}
```

### 7.2 RESTful API（预留）
```yaml
endpoints:
  categories:
    - GET /api/v1/categories
    - POST /api/v1/categories
    - PUT /api/v1/categories/{id}
    - DELETE /api/v1/categories/{id}
  
  transactions:
    - GET /api/v1/transactions
    - POST /api/v1/transactions
    - PUT /api/v1/transactions/{id}
    - DELETE /api/v1/transactions/{id}
    - GET /api/v1/transactions/stats
```

## 8. 数据库设计

### 8.1 Hive数据模型
```dart
@HiveType(typeId: 0)
class CategoryModel extends HiveObject {
  @HiveField(0)
  String id;
  
  @HiveField(1)
  String name;
  
  @HiveField(2)
  String icon;
  
  @HiveField(3)
  int color;
  
  @HiveField(4)
  int type; // 0: expense, 1: income
  
  @HiveField(5)
  double currentAmount;
  
  @HiveField(6)
  double targetAmount;
  
  @HiveField(7)
  DateTime createdAt;
  
  @HiveField(8)
  DateTime updatedAt;
  
  @HiveField(9)
  List<SubCategoryModel> subCategories;
}

@HiveType(typeId: 1)
class TransactionModel extends HiveObject {
  @HiveField(0)
  String id;
  
  @HiveField(1)
  String categoryId;
  
  @HiveField(2)
  String? subCategoryId;
  
  @HiveField(3)
  double amount;
  
  @HiveField(4)
  String? note;
  
  @HiveField(5)
  DateTime date;
  
  @HiveField(6)
  int type; // 0: expense, 1: income
}
```

### 8.2 索引设计
- categories: 按type索引，按createdAt排序
- transactions: 按date索引，按categoryId索引，复合索引(date, categoryId)

## 9. UI/UX架构

### 9.1 设计系统
```dart
class AppTheme {
  static ThemeData lightTheme = ThemeData(
    primarySwatch: Colors.blue,
    scaffoldBackgroundColor: Color(0xFFF5F5F5),
    cardTheme: CardTheme(
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
    ),
  );
  
  static ThemeData darkTheme = ThemeData(
    brightness: Brightness.dark,
    primarySwatch: Colors.blue,
    scaffoldBackgroundColor: Color(0xFF121212),
  );
}
```

### 9.2 组件库
- **基础组件**: Button, Card, Input, Dialog
- **业务组件**: CategoryCard, TransactionItem, StatChart
- **布局组件**: ResponsiveLayout, GridView, ListView

### 9.3 动画规范
```dart
class AnimationConstants {
  static const Duration short = Duration(milliseconds: 200);
  static const Duration medium = Duration(milliseconds: 300);
  static const Duration long = Duration(milliseconds: 500);
  
  static const Curve defaultCurve = Curves.easeInOut;
  static const Curve bounceCurve = Curves.elasticOut;
}
```

## 10. 测试策略

### 10.1 单元测试
```dart
// 用例测试
test('AddCategory should add category successfully', () async {
  final mockRepo = MockCategoryRepository();
  final useCase = AddCategory(mockRepo);
  
  when(mockRepo.addCategory(any))
    .thenAnswer((_) async => Right(testCategory));
  
  final result = await useCase(AddCategoryParams(
    name: 'Food',
    icon: '🍔',
    color: Colors.orange.value,
  ));
  
  expect(result, Right(testCategory));
  verify(mockRepo.addCategory(any));
});
```

### 10.2 Widget测试
```dart
testWidgets('DragRecordInput should detect category', (tester) async {
  await tester.pumpWidget(
    MaterialApp(
      home: DragRecordInputNew(),
    ),
  );
  
  await tester.drag(
    find.byType(DraggableRecordDot),
    Offset(100, 0),
  );
  
  expect(find.text('Food'), findsOneWidget);
});
```

### 10.3 集成测试
```dart
testWidgets('Complete transaction flow', (tester) async {
  app.main();
  await tester.pumpAndSettle();
  
  // 拖拽添加交易
  await tester.drag(find.byType(DraggableRecordDot), Offset(100, 0));
  await tester.enterText(find.byType(TextField), '50.0');
  await tester.tap(find.text('确认'));
  await tester.pumpAndSettle();
  
  // 验证交易已添加
  expect(find.text('¥50.00'), findsOneWidget);
});
```

## 11. 部署架构

### 11.1 构建配置
```yaml
flutter:
  assets:
    - assets/icons/
    - assets/images/
  
  fonts:
    - family: Roboto
      fonts:
        - asset: fonts/Roboto-Regular.ttf
        - asset: fonts/Roboto-Bold.ttf
          weight: 700
```

### 11.2 平台特定配置
- **Android**: minSdkVersion 21, targetSdkVersion 33
- **iOS**: iOS 11.0+
- **Web**: 支持PWA，Service Worker缓存

### 11.3 发布流程
1. 版本号更新
2. 代码混淆配置
3. 签名配置
4. 多渠道打包
5. 自动化部署

## 12. 性能优化

### 12.1 启动优化
- 懒加载非关键模块
- 预加载常用数据
- 启动页优化
- 首屏渲染优化

### 12.2 运行时优化
```dart
// 列表优化
ListView.builder(
  itemBuilder: (context, index) {
    return TransactionItem(
      key: ValueKey(transactions[index].id),
      transaction: transactions[index],
    );
  },
  itemCount: transactions.length,
  cacheExtent: 1000, // 缓存区域
);

// 图片优化
CachedNetworkImage(
  imageUrl: imageUrl,
  placeholder: (context, url) => CircularProgressIndicator(),
  errorWidget: (context, url, error) => Icon(Icons.error),
);
```

### 12.3 内存优化
- 及时释放不用的资源
- 使用const构造函数
- 避免内存泄漏
- 图片缓存管理

## 13. 安全设计

### 13.1 数据加密
```dart
class EncryptionService {
  static Future<String> encrypt(String plainText) async {
    final key = await _getEncryptionKey();
    final encrypter = Encrypter(AES(key));
    final encrypted = encrypter.encrypt(plainText, iv: _iv);
    return encrypted.base64;
  }
  
  static Future<String> decrypt(String encryptedText) async {
    final key = await _getEncryptionKey();
    final encrypter = Encrypter(AES(key));
    final decrypted = encrypter.decrypt64(encryptedText, iv: _iv);
    return decrypted;
  }
}
```

### 13.2 生物识别
```dart
class BiometricAuth {
  static Future<bool> authenticate() async {
    final LocalAuthentication auth = LocalAuthentication();
    
    final bool canCheckBiometrics = await auth.canCheckBiometrics;
    if (!canCheckBiometrics) return false;
    
    final bool didAuthenticate = await auth.authenticate(
      localizedReason: '请验证身份以访问MoneyJars',
      options: AuthenticationOptions(
        biometricOnly: true,
        stickyAuth: true,
      ),
    );
    
    return didAuthenticate;
  }
}
```

## 14. 迁移指南

### 14.1 数据迁移步骤
1. **备份旧数据**
   ```dart
   await DataMigrationTool.backupOldData();
   ```

2. **转换数据格式**
   ```dart
   final oldData = await DataMigrationTool.readOldData();
   final newData = DataMigrationTool.convertToNewFormat(oldData);
   ```

3. **导入新系统**
   ```dart
   await DataMigrationTool.importToNewSystem(newData);
   ```

4. **验证数据完整性**
   ```dart
   final isValid = await DataMigrationTool.validateMigration();
   ```

### 14.2 代码迁移检查清单
- [ ] 所有Provider已迁移到新架构
- [ ] 旧的直接数据访问已替换为Repository
- [ ] UI组件已更新使用新的Provider
- [ ] 测试用例已更新
- [ ] 文档已更新

## 15. 版本历史

### v2.0.0 (2025-01-20)
- 完全重构为Clean Architecture
- 新增拖拽式记账功能
- 优化性能和用户体验
- 支持深色模式
- 数据迁移工具

### v1.0.0 (2024-XX-XX)
- 初始版本发布
- 基础记账功能
- 分类管理
- 数据统计

## 16. 待办事项

### 高优先级
- [ ] 完成UI迁移到生产环境
- [ ] 实现云同步功能
- [ ] 添加数据导出功能
- [ ] 性能监控集成

### 中优先级
- [ ] 多语言支持
- [ ] 预算提醒功能
- [ ] 自定义报表
- [ ] 社交分享功能

### 低优先级
- [ ] AI智能分类
- [ ] 语音输入
- [ ] 小组件支持
- [ ] Apple Watch应用

---

**文档维护说明**: 本文档应随着项目发展持续更新，每次重大架构变更都应在此记录。