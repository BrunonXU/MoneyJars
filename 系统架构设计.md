# MoneyJars 系统架构设计

## 1. 项目概述
MoneyJars是一个创新的个人财务管理应用，采用拖拽式交互设计，让记账变得简单有趣。

## 2. 技术栈
- **框架**: Flutter 3.x
- **状态管理**: Provider
- **本地存储**: Hive
- **架构模式**: Clean Architecture
- **依赖注入**: get_it

## 3. 架构设计

### 3.1 整体架构 (Clean Architecture)
```
lib/
├── core/                    # 核心层
│   ├── domain/             # 领域层（业务逻辑）
│   │   ├── entities/       # 实体
│   │   ├── repositories/   # 仓库接口
│   │   └── services/       # 服务接口
│   ├── data/              # 数据层
│   │   ├── models/        # 数据模型
│   │   ├── datasources/   # 数据源
│   │   └── repositories/  # 仓库实现
│   └── di/                # 依赖注入
├── presentation/          # 表现层
│   ├── providers/        # 状态管理
│   ├── pages/           # 页面
│   └── widgets/         # 组件
└── app/                 # 应用配置
```

### 3.2 核心实体

#### Transaction (交易)
```dart
class Transaction {
  final String id;
  final double amount;
  final String description;
  final String parentCategoryId;
  final String parentCategoryName;
  final TransactionType type;
  final DateTime date;
  final DateTime createdAt;
  // 扩展字段
  final String userId;
  final List<String> tags;
  final List<String> attachments;
  final String? location;
  final DateTime? syncedAt;
}
```

#### Category (分类)
```dart
class Category {
  final String id;
  final String name;
  final TransactionType type;
  final int color;
  final String icon;
  final List<SubCategory> subCategories;
  final bool isSystem;
  final int usageCount;
}
```

### 3.3 数据流
1. **UI层** → 触发事件
2. **Provider** → 调用Repository
3. **Repository** → 协调DataSource
4. **DataSource** → 访问Hive/API
5. **数据返回** → 通过层层传递更新UI

## 4. 功能模块

### 4.1 已实现功能
- ✅ 交易管理（CRUD）
- ✅ 分类管理（两级分类）
- ✅ 拖拽输入（创新交互）
- ✅ 数据统计（饼图、柱状图）
- ✅ 本地存储（Hive）

### 4.2 新架构进展
- ✅ Clean Architecture框架搭建
- ✅ 领域实体定义
- ✅ 仓库模式实现
- ✅ Provider状态管理迁移
- ✅ UI组件模块化
- ✅ 双模式运行（新旧架构并存）

### 4.3 待实现功能
- ⏳ 完整仓库方法
- ⏳ 拖拽组件迁移
- ⏳ 数据迁移工具
- ⏳ 性能优化
- ⏳ 多语言支持

## 5. 迁移策略

### 5.1 双模式运行
- **旧架构**: `lib/main.dart` (生产环境，原有UI和逻辑100%保留)
- **新架构**: `lib/main_new.dart` (测试版，仅验证架构可行性)
- **测试版**: `lib/main_simple.dart` (最小化验证)

**重要说明**：新架构不是要替换原有UI和操作逻辑，而是为了：
- 提供更好的代码组织结构
- 让拖拽输入等创新功能更易维护
- 为未来功能扩展打基础
- 保持与原有数据100%兼容

### 5.2 向后兼容
通过`StorageServiceAdapter`实现新旧架构的无缝切换，确保数据一致性。

## 6. 开发进度

### 当前状态：90%完成
✅ 主体架构搭建完成
✅ 核心功能框架就绪
✅ 基础UI组件实现
✅ 新架构应用成功启动（lib/main_new.dart可运行）
⏳ 剩余工作：setState时机优化、拖拽组件迁移、数据导出功能

### 最新进展（2025-01-20）
1. **修复所有编译错误**
   - LocalDataSource添加缺失方法
   - 修复CategoryProvider中SubCategory.id问题
   - 解决路由常量冲突
   - 添加TransactionType导入

2. **成功运行新架构**
   - `flutter run -d chrome lib/main_new.dart`已可正常运行
   - 启动页动画和数据加载正常
   - 发现setState时机问题需优化

### 剩余工作详细分析（10%未完成）

#### 1. 必须完成的核心功能（高优先级）
- **修复setState时机问题** [1小时]
  - 在initState中使用WidgetsBinding.instance.addPostFrameCallback
  - 避免在build过程中调用notifyListeners
  
- **完善新架构基础功能** [2-3小时]
  - 交易列表正常显示
  - 添加交易功能验证
  - 分类选择功能
  - 删除交易功能

- **迁移拖拽输入组件** [4-5小时] ⭐最重要
  - 这是应用的核心亮点，必须100%还原
  - 将drag_record_input_new.dart集成到新架构
  - 保持原有的动画效果和交互体验
  - 确保拖拽分类的准确性

#### 2. 增值功能（中优先级）
- **数据迁移和导出** [2-3小时]
  - 实现新旧数据结构的自动迁移
  - CSV/Excel导出功能
  - 数据备份恢复

- **性能优化** [2小时]
  - 实现Provider的缓存机制
  - 优化列表滚动性能
  - 减少不必要的Widget重建

#### 3. 锦上添花（低优先级）
- **多语言支持** [3小时]
  - 提取所有中文字符串
  - 实现国际化框架
  - 至少支持中英文

- **代码注释完善** [2小时]
  - 为所有公共API添加文档注释
  - 复杂业务逻辑添加说明

### 总计剩余工作量
- **必须完成**：7-9小时
- **建议完成**：4-5小时  
- **可选完成**：5小时
- **总计**：16-19小时工作量

### 关键点
1. **拖拽输入是灵魂**：这是您应用的创新点，必须完美迁移
2. **数据兼容是基础**：确保用户数据安全迁移
3. **体验不能降级**：新架构必须保持原有的流畅体验

## 7. 代码规范

### 命名规范
- 文件名：snake_case
- 类名：PascalCase
- 变量/方法：camelCase
- 常量：UPPER_SNAKE_CASE

### 注释规范
- 每个文件头部说明功能
- 复杂逻辑添加注释
- 公共API必须有文档注释

## 8. 性能优化

### 已实现
- 懒加载Provider
- 组件拆分减少重建
- 本地缓存机制

### 计划中
- 查询优化
- 图片懒加载
- 动画性能优化

---
*最后更新: 2025-01-20*