# MoneyJars 代码重构计划

## 当前状态分析

### 1. 存在两套并行的代码结构
- **原方案代码**：主要在 `lib/screens`、`lib/widgets`、`lib/providers`、`lib/models` 目录下
- **新架构代码**：主要在 `lib/core` 和 `lib/presentation` 目录下，遵循 Clean Architecture

### 2. 代码混乱的问题
- 功能重复：如有两个 transaction_provider
- 组件重复：如有两套 jar 相关的 widget
- 命名不一致：有些文件带 `_new` 后缀，有些没有

## 重构目标

1. **统一目录结构**：采用 Clean Architecture 的目录结构
2. **消除重复代码**：合并功能相同的代码
3. **保留精华功能**：保留原方案的核心功能和优秀设计
4. **命名规范化**：去除临时的 `_new` 后缀，统一命名规范

## 重构方案

### 第一阶段：目录结构调整

```
lib/
├── core/                        # 核心业务逻辑（Clean Architecture）
│   ├── domain/                  # 领域层
│   │   ├── entities/           # 实体
│   │   ├── repositories/       # 仓库接口
│   │   └── usecases/          # 用例
│   ├── data/                   # 数据层
│   │   ├── models/            # 数据模型
│   │   ├── datasources/       # 数据源
│   │   └── repositories/      # 仓库实现
│   └── utils/                  # 核心工具类
│
├── presentation/               # 表现层
│   ├── pages/                 # 页面
│   │   ├── home/             # 主页
│   │   ├── detail/           # 详情页
│   │   ├── statistics/       # 统计页
│   │   ├── help/             # 帮助页
│   │   └── personalization/  # 个性化页
│   ├── widgets/               # 可复用组件
│   │   ├── common/           # 通用组件
│   │   ├── jar/              # 罐头相关组件
│   │   ├── transaction/      # 交易相关组件
│   │   ├── navigation/       # 导航相关组件
│   │   ├── input/            # 输入相关组件
│   │   └── statistics/       # 统计相关组件
│   └── providers/             # 状态管理
│
├── constants/                  # 常量定义
├── utils/                     # 工具类
├── services/                  # 服务层
└── app/                       # 应用入口
```

### 第二阶段：代码迁移计划

#### 1. Models 迁移
- [x] 保留 `transaction_record_hive.dart` 作为主要数据模型
- [ ] 将其移动到 `core/data/models/`
- [ ] 整合 `transaction_model.dart` 的功能

#### 2. Providers 迁移
- [x] 使用原方案的 `transaction_provider.dart`
- [ ] 移动到 `presentation/providers/`
- [ ] 删除 `transaction_provider_new.dart`

#### 3. Screens 迁移
- [ ] `home_screen.dart` → `presentation/pages/home/home_page.dart`
- [ ] `jar_detail_page.dart` → `presentation/pages/detail/jar_detail_page.dart`
- [ ] `statistics_page.dart` → `presentation/pages/statistics/statistics_page.dart`
- [ ] `help_page.dart` → `presentation/pages/help/help_page.dart`
- [ ] `personalization_page.dart` → `presentation/pages/personalization/personalization_page.dart`
- [ ] 删除 `settings_page.dart`（已迁移到侧边栏）

#### 4. Widgets 迁移
- [ ] `money_jar_widget.dart` → `presentation/widgets/jar/money_jar_widget.dart`
- [ ] `drag_record_input.dart` → `presentation/widgets/input/drag_record_input.dart`
- [ ] `enhanced_transaction_input.dart` → `presentation/widgets/input/transaction_input.dart`
- [ ] 整合重复的组件

#### 5. 清理工作
- [ ] 删除所有带 `_new` 后缀的文件
- [ ] 删除未使用的文件
- [ ] 更新所有 import 语句

### 第三阶段：功能整合

1. **拖拽输入功能**
   - 整合原方案和新架构的拖拽输入实现
   - 保留原方案的交互设计
   - 使用新架构的状态管理

2. **分类管理功能**
   - 使用新架构的分类系统
   - 保留原方案的 UI 设计

3. **数据统计功能**
   - 整合两套统计实现
   - 优化性能

### 第四阶段：性能优化

1. **实现查询缓存机制**
   - 在 Provider 层添加缓存
   - 减少数据库查询

2. **优化列表滚动性能**
   - 使用 ListView.builder
   - 实现虚拟滚动

3. **减少不必要的 Widget 重建**
   - 使用 const constructor
   - 合理使用 setState

## 执行计划

### 优先级高
1. 目录结构调整
2. 核心功能文件迁移
3. 更新 import 语句

### 优先级中
1. 整合重复功能
2. 统一命名规范
3. 清理无用代码

### 优先级低
1. 性能优化
2. 添加注释
3. 编写测试

## 注意事项

1. **保持功能完整性**：每次迁移后都要测试功能是否正常
2. **逐步迁移**：不要一次性大改，避免引入 bug
3. **版本控制**：每个阶段完成后及时提交
4. **备份重要代码**：在删除前确保功能已经迁移

## 预期结果

1. 统一、清晰的代码结构
2. 消除代码重复
3. 提高代码可维护性
4. 保留所有核心功能
5. 性能得到优化